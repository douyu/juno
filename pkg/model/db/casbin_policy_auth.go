package db

import (
	"database/sql/driver"
	"encoding/json"

	"github.com/jinzhu/gorm"
)

type (
	CasbinPolicyObject struct {
		URL     *string `json:"url,omitempty"`
		AppName *string `json:"app_name,omitempty"`
		Menu    *string `json:"menu,omitempty"`
	}

	CasbinPolicyType string

	CasbinPolicyAuth struct {
		gorm.Model
		Sub  string           `gorm:"not null;"json:"sub"`
		Obj  string           `gorm:"type:varchar(255);not null;"json:"obj"`
		Act  string           `gorm:"type:varchar(255);not null;"json:"act"`
		Type CasbinPolicyType `gorm:"not null;"json:"type"`
	}
)

var (
	CasbinPolicyTypeMenu    CasbinPolicyType = "menu"
	CasbinPolicyTypeApp     CasbinPolicyType = "app"
	CasbinPolicyTypeAPI     CasbinPolicyType = "api"
	CasbinPolicyTypeMonitor CasbinPolicyType = "monitor" // Grafana权限

	// 监控面板权限
	MonitorPermWrite = "monitor:write"

	AppPermAppRead            = "app:read"
	AppPermConfigRead         = "config:read"
	AppPermConfigWrite        = "config:write"
	AppPermConfigReadInstance = "config:readInstance"
	AppPermMonitorRead        = "monitor:read"
	AppPermPProfRead          = "pprof:read"
	AppPermPProfRun           = "pprof:run"
)

func (c CasbinPolicyAuth) TableName() string {
	return "casbin_policy_auth"
}

func (c *CasbinPolicyObject) Scan(src interface{}) error {
	return json.Unmarshal(src.([]byte), c)
}

func (c CasbinPolicyObject) Value() (driver.Value, error) {
	val, err := json.Marshal(c)
	return string(val), err
}
